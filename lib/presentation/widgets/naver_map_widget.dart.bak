import 'package:flutter/material.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import 'package:geolocator/geolocator.dart';
import 'package:webview_flutter/webview_flutter.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import '../../services/location_service.dart';
import '../../domain/entities/company_entity.dart';
import '../views/map/fullscreen_map_view.dart';

class NaverMapWidget extends StatefulWidget {
  final List<CompanyEntity> companies;
  final Function(CompanyEntity)? onCompanyTapped;

  const NaverMapWidget({
    super.key,
    required this.companies,
    this.onCompanyTapped,
  });

  @override
  State<NaverMapWidget> createState() => _NaverMapWidgetState();
}

class _NaverMapWidgetState extends State<NaverMapWidget> {
  final LocationService _locationService = LocationService();
  late final WebViewController _webViewController;
  Position? _currentPosition;
  bool _isLoading = true;
  bool _mapLoadingError = false;
  
  // ë„¤ì´ë²„ ì§€ë„ API ì„¤ì •
  static String get _naverClientId => dotenv.env['Naver_Maps_Client_ID'] ?? 'wvvufspvmb';

  @override
  void initState() {
    super.initState();
    _initializeWebView();
    _initializeLocation();
  }

  void _initializeWebView() {
    _webViewController = WebViewController()
      ..setJavaScriptMode(JavaScriptMode.unrestricted)
      ..setNavigationDelegate(
        NavigationDelegate(
          onPageStarted: (String url) {
            debugPrint('ğŸ”„ ì§€ë„ í˜ì´ì§€ ë¡œë”© ì‹œì‘: $url');
          },
          onPageFinished: (String url) {
            debugPrint('âœ… ì§€ë„ í˜ì´ì§€ ë¡œë”© ì™„ë£Œ: $url');
            setState(() {
              _isLoading = false;
            });
          },
          onWebResourceError: (WebResourceError error) {
            debugPrint('âŒ ì§€ë„ ë¡œë”© ì—ëŸ¬: ${error.description}');
            setState(() {
              _mapLoadingError = true;
              _isLoading = false;
            });
          },
        },
      );
  }

  Future<void> _initializeLocation() async {
    try {
      final position = await _locationService.getCurrentLocation();
      if (position != null) {
        _currentPosition = position;
        debugPrint('ğŸ“ í˜„ì¬ ìœ„ì¹˜: ${position.latitude}, ${position.longitude}');
        _loadMap();
      } else {
        debugPrint('âš ï¸ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        // ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸)ë¡œ ì„¤ì •
        _currentPosition = Position(
          latitude: 37.5665,
          longitude: 126.9780,
          timestamp: DateTime.now(),
          accuracy: 0,
          altitude: 0,
          heading: 0,
          speed: 0,
          speedAccuracy: 0,
          altitudeAccuracy: 0,
          headingAccuracy: 0,
        );
        _loadMap();
      }
    } catch (e) {
      debugPrint('âŒ ìœ„ì¹˜ ì´ˆê¸°í™” ì‹¤íŒ¨: $e');
      // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì§€ë„ ë¡œë“œ
      _currentPosition = Position(
        latitude: 37.5665,
        longitude: 126.9780,
        timestamp: DateTime.now(),
        accuracy: 0,
        altitude: 0,
        heading: 0,
        speed: 0,
        speedAccuracy: 0,
        altitudeAccuracy: 0,
        headingAccuracy: 0,
      );
      _loadMap();
    }
  }

  void _loadMap() {
    try {
      final mapHtml = _buildNaverMapHtml();
      debugPrint('ğŸ—ºï¸ ë„¤ì´ë²„ ì§€ë„ HTML ìƒì„± ì™„ë£Œ');
      _webViewController.loadHtmlString(mapHtml);
    } catch (e) {
      debugPrint('âŒ ì§€ë„ ë¡œë“œ ì‹¤íŒ¨: $e');
      setState(() {
        _mapLoadingError = true;
        _isLoading = false;
      });
    }
  }

  String _buildNaverMapHtml() {
    double lat = _currentPosition?.latitude ?? 37.5665;
    double lng = _currentPosition?.longitude ?? 126.9780;

    return '''
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„ ì§€ë„</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=$_naverClientId"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif;
        }
        #map { 
            width: 100%; 
            height: 100vh; 
            background: #f0f0f0;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }
        .company-marker { 
            background: #ff6b35; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .premium-marker { 
            background: #ffd700; 
            border-radius: 50%; 
            width: 28px; 
            height: 28px; 
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .current-location-marker {
            background: #4285f4; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
        }
        .current-location-marker::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(66, 133, 244, 0.2);
            animation: pulse 2s ease-out infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
    </style>
</head>
<body>
    <div id="map">
        <div class="loading">
            <h3>ë„¤ì´ë²„ ì§€ë„ ë¡œë”© ì¤‘...</h3>
            <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
        </div>
    </div>
    
    <script>
        console.log('ë„¤ì´ë²„ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘');
        
        // ë„¤ì´ë²„ ì§€ë„ API ë¡œë”© í™•ì¸
        function initMap() {
            try {
                console.log('ì§€ë„ ì´ˆê¸°í™” ì‹œì‘');
                
                var map = new naver.maps.Map('map', {
                    center: new naver.maps.LatLng($lat, $lng),
                    zoom: 14,
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: naver.maps.MapTypeControlStyle.DROPDOWN,
                        position: naver.maps.Position.TOP_RIGHT
                    },
                    zoomControl: true,
                    zoomControlOptions: {
                        style: naver.maps.ZoomControlStyle.SMALL,
                        position: naver.maps.Position.TOP_RIGHT
                    }
                });
                
                console.log('ì§€ë„ ìƒì„± ì™„ë£Œ');

                // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤
                var currentLocationMarker = new naver.maps.Marker({
                    position: new naver.maps.LatLng($lat, $lng),
                    map: map,
                    icon: {
                        content: '<div class="current-location-marker"></div>',
                        size: new naver.maps.Size(20, 20),
                        anchor: new naver.maps.Point(10, 10)
                    },
                    zIndex: 100
                });
                
                var currentInfoWindow = new naver.maps.InfoWindow({
                    content: '<div style="padding: 10px; font-weight: bold;">ğŸ“ í˜„ì¬ ìœ„ì¹˜</div>'
                });
                
                naver.maps.Event.addListener(currentLocationMarker, 'click', function() {
                    if (currentInfoWindow.getMap()) {
                        currentInfoWindow.close();
                    } else {
                        currentInfoWindow.open(map, currentLocationMarker);
                    }
                });
                
                console.log('í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€ ì™„ë£Œ');

                // íšŒì‚¬ ë§ˆì»¤ë“¤ ì¶”ê°€
                var companies = ${_buildCompaniesJson()};
                console.log('íšŒì‚¬ ë°ì´í„°:', companies);
                
                var bounds = new naver.maps.LatLngBounds();
                bounds.extend(new naver.maps.LatLng($lat, $lng));
                
                companies.forEach(function(company, index) {
                    if (company.latitude && company.longitude) {
                        var position = new naver.maps.LatLng(company.latitude, company.longitude);
                        bounds.extend(position);
                        
                        var marker = new naver.maps.Marker({
                            position: position,
                            map: map,
                            icon: {
                                content: '<div class="' + (company.adPayment > 0 ? 'premium-marker' : 'company-marker') + '"></div>',
                                size: new naver.maps.Size(company.adPayment > 0 ? 28 : 24, company.adPayment > 0 ? 28 : 24),
                                anchor: new naver.maps.Point(company.adPayment > 0 ? 14 : 12, company.adPayment > 0 ? 14 : 12)
                            },
                            zIndex: company.adPayment > 0 ? 50 : 10
                        });

                        var infoWindow = new naver.maps.InfoWindow({
                            content: '<div style="padding: 15px; min-width: 200px; max-width: 300px;">' +
                                     '<h3 style="margin: 0 0 8px 0; font-size: 16px; color: #333;">' + company.companyName + '</h3>' +
                                     '<p style="margin: 0 0 5px 0; color: #666; font-size: 14px;">' + (company.subcategory || 'ì¹´í…Œê³ ë¦¬ ì—†ìŒ') + '</p>' +
                                     (company.adPayment > 0 ? '<p style="margin: 0; color: #ffa500; font-weight: bold; font-size: 12px;">â­ í”„ë¦¬ë¯¸ì—„ ê´‘ê³ </p>' : '') +
                                     '</div>',
                            backgroundColor: '#fff',
                            borderWidth: 2,
                            borderColor: company.adPayment > 0 ? '#ffd700' : '#ddd',
                            anchorSize: new naver.maps.Size(20, 20),
                            anchorSkew: true
                        });

                        naver.maps.Event.addListener(marker, 'click', function() {
                            // ë‹¤ë¥¸ ì •ë³´ì°½ ë‹«ê¸°
                            companies.forEach(function(c) {
                                if (c.infoWindow && c.infoWindow !== infoWindow) {
                                    c.infoWindow.close();
                                }
                            });
                            
                            if (infoWindow.getMap()) {
                                infoWindow.close();
                            } else {
                                infoWindow.open(map, marker);
                            }
                        });
                        
                        company.marker = marker;
                        company.infoWindow = infoWindow;
                        
                        console.log('íšŒì‚¬ ë§ˆì»¤ ì¶”ê°€ ì™„ë£Œ:', company.companyName);
                    }
                });

                // ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì§€ë„ ì˜ì—­ ì¡°ì •
                if (companies.length > 0) {
                    map.fitBounds(bounds, { 
                        top: 50, 
                        right: 50, 
                        bottom: 50, 
                        left: 50 
                    });
                }

                // í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
                window.moveToCurrentLocation = function() {
                    map.setCenter(new naver.maps.LatLng($lat, $lng));
                    map.setZoom(15);
                    console.log('í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™');
                };
                
                // ì§€ë„ í´ë¦­ ì‹œ ì •ë³´ì°½ ë‹«ê¸°
                naver.maps.Event.addListener(map, 'click', function(e) {
                    companies.forEach(function(company) {
                        if (company.infoWindow) {
                            company.infoWindow.close();
                        }
                    });
                    currentInfoWindow.close();
                });
                
                console.log('ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                console.error('ì§€ë„ ì´ˆê¸°í™” ì—ëŸ¬:', error);
                document.getElementById('map').innerHTML = '<div class="loading"><h3>ì§€ë„ ë¡œë”© ì‹¤íŒ¨</h3><p>ì—ëŸ¬: ' + error.message + '</p><p>API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p></div>';
            }
        }
        
        // ë„¤ì´ë²„ ì§€ë„ APIê°€ ë¡œë“œë˜ë©´ ì´ˆê¸°í™”
        if (typeof naver !== 'undefined' && naver.maps) {
            console.log('ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œë¨');
            initMap();
        } else {
            console.log('ë„¤ì´ë²„ ì§€ë„ API ë¡œë”© ëŒ€ê¸° ì¤‘...');
            // API ë¡œë”© ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¼
            var checkInterval = setInterval(function() {
                if (typeof naver !== 'undefined' && naver.maps) {
                    console.log('ë„¤ì´ë²„ ì§€ë„ API ë¡œë“œ ì™„ë£Œ');
                    clearInterval(checkInterval);
                    initMap();
                }
            }, 100);
            
            // 10ì´ˆ í›„ì—ë„ ë¡œë“œë˜ì§€ ì•Šìœ¼ë©´ ì—ëŸ¬ í‘œì‹œ
            setTimeout(function() {
                if (typeof naver === 'undefined' || !naver.maps) {
                    clearInterval(checkInterval);
                    document.getElementById('map').innerHTML = '<div class="loading"><h3>ë„¤ì´ë²„ ì§€ë„ API ë¡œë”© ì‹¤íŒ¨</h3><p>API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p></div>';
                }
            }, 10000);
        }
    </script>
</body>
</html>
    ''';
  }

  String _buildCompaniesJson() {
    final companiesData = widget.companies.map((company) => {
      '"id"': '"${company.id}"',
      '"companyName"': '"${company.companyName.replaceAll('"', '\\"').replaceAll('\n', '\\n')}"',
      '"subcategory"': '"${company.subcategory?.replaceAll('"', '\\"').replaceAll('\n', '\\n') ?? ''}"',
      '"latitude"': company.latitude,
      '"longitude"': company.longitude,
      '"adPayment"': company.adPayment,
    }).map((item) => '{${item.entries.map((e) => '${e.key}: ${e.value}').join(', ')}}').join(', ');
    return '[$companiesData]';
  }

  @override
  Widget build(BuildContext context) {
    if (_isLoading && _currentPosition == null) {
      return _buildLoadingPlaceholder();
    }

    if (_mapLoadingError) {
      return _buildErrorPlaceholder();
    }

    return _buildNaverMap();
  }

  Widget _buildLoadingPlaceholder() {
    return Container(
      height: 400.h,
      decoration: BoxDecoration(
        color: Colors.grey[100],
        borderRadius: BorderRadius.circular(8.r),
        border: Border.all(color: Colors.grey[300]!),
      ),
      child: const Center(
        child: CircularProgressIndicator(),
      ),
    );
  }

  Widget _buildErrorPlaceholder() {
    return Container(
      height: 400.h,
      decoration: BoxDecoration(
        color: Colors.grey[100],
        borderRadius: BorderRadius.circular(8.r),
        border: Border.all(color: Colors.grey[300]!),
      ),
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              Icons.error_outline,
              size: 48.sp,
              color: Colors.red[400],
            ),
            SizedBox(height: 8.h),
            Text(
              'ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
              textAlign: TextAlign.center,
              style: TextStyle(
                fontSize: 14.sp,
                color: Colors.grey[600],
              ),
            ),
            SizedBox(height: 8.h),
            ElevatedButton(
              onPressed: () {
                setState(() {
                  _mapLoadingError = false;
                  _isLoading = true;
                });
                _initializeLocation();
              },
              child: const Text('ë‹¤ì‹œ ì‹œë„'),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildNaverMap() {
    return Container(
      height: 400.h,
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(8.r),
        border: Border.all(color: Colors.grey[300]!),
        color: Colors.white,
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(8.r),
        child: Stack(
          children: [
            // WebViewë¡œ ë„¤ì´ë²„ ì§€ë„ í‘œì‹œ
            WebViewWidget(controller: _webViewController),
            // ì§€ë„ ì»¨íŠ¸ë¡¤
            _buildMapControls(),
            // ë¡œë”© ì¤‘ í‘œì‹œ
            if (_isLoading)
              Container(
                color: Colors.white.withValues(alpha: 0.8),
                child: const Center(
                  child: CircularProgressIndicator(),
                ),
              ),
          ],
        ),
      ),
    );
  }

  Widget _buildMapControls() {
    return Positioned(
      top: 8.h,
      right: 8.w,
      child: Column(
        children: [
          // í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼
          Container(
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(6.r),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.1),
                  blurRadius: 4,
                  offset: const Offset(0, 2),
                ),
              ],
            ),
            child: IconButton(
              onPressed: _moveToCurrentLocation,
              icon: Icon(
                Icons.my_location,
                size: 20.sp,
                color: const Color(0xFF1E3A5F),
              ),
              padding: EdgeInsets.all(8.w),
              constraints: BoxConstraints(
                minWidth: 36.w,
                minHeight: 36.h,
              ),
            ),
          ),
          SizedBox(height: 8.h),
          // ì „ì²´í™”ë©´ ë²„íŠ¼
          Container(
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(6.r),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.1),
                  blurRadius: 4,
                  offset: const Offset(0, 2),
                ),
              ],
            ),
            child: IconButton(
              onPressed: _openFullscreenMap,
              icon: Icon(
                Icons.fullscreen,
                size: 20.sp,
                color: const Color(0xFF1E3A5F),
              ),
              padding: EdgeInsets.all(8.w),
              constraints: BoxConstraints(
                minWidth: 36.w,
                minHeight: 36.h,
              ),
            ),
          ),
        ],
      ),
    );
  }

  void _moveToCurrentLocation() {
    if (_currentPosition != null) {
      _webViewController.runJavaScript('moveToCurrentLocation()');
    }
  }

  void _openFullscreenMap() {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => FullscreenMapView(
          companies: widget.companies,
          currentPosition: _currentPosition,
          onCompanyTapped: widget.onCompanyTapped,
        ),
      ),
    );
  }
}