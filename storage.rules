rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // 사용자 프로필 이미지
    match /users/{userId}/avatar/{filename} {
      allow read: if true; // 모든 사용자가 읽기 가능
      allow write: if request.auth != null && 
                   request.auth.uid == userId &&
                   isValidImageFile() &&
                   request.resource.size < 5 * 1024 * 1024; // 5MB 제한
    }
    
    // 기업 이미지 (로고, 사진)
    match /companies/{companyId}/images/{filename} {
      allow read: if true; // 모든 사용자가 읽기 가능
      allow write: if request.auth != null &&
                   isValidImageFile() &&
                   request.resource.size < 10 * 1024 * 1024; // 10MB 제한
    }
    
    // 기업 로고
    match /companies/{companyId}/logo/{filename} {
      allow read: if true; // 모든 사용자가 읽기 가능
      allow write: if request.auth != null &&
                   isValidImageFile() &&
                   request.resource.size < 2 * 1024 * 1024; // 2MB 제한
    }
    
    // 게시글 이미지
    match /posts/{postId}/images/{filename} {
      allow read: if true; // 모든 사용자가 읽기 가능
      allow write: if request.auth != null &&
                   isValidImageFile() &&
                   request.resource.size < 10 * 1024 * 1024; // 10MB 제한
    }
    
    // 문의 첨부파일
    match /inquiries/{inquiryId}/attachments/{filename} {
      // 해당 문의 작성자만 업로드/다운로드 가능
      allow read, write: if request.auth != null &&
                        isValidAttachmentFile() &&
                        request.resource.size < 20 * 1024 * 1024; // 20MB 제한
    }
    
    // 임시 업로드 폴더 (24시간 후 자동 삭제 예정)
    match /temp/{userId}/{filename} {
      allow read, write: if request.auth != null &&
                        request.auth.uid == userId &&
                        request.resource.size < 50 * 1024 * 1024; // 50MB 제한
    }
    
    // 유효성 검사 함수들
    function isValidImageFile() {
      return request.resource.contentType.matches('image/.*') &&
             request.resource.contentType in ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    }
    
    function isValidAttachmentFile() {
      return request.resource.contentType in [
        'image/jpeg', 'image/png', 'image/webp', 'image/gif', // 이미지
        'application/pdf', // PDF
        'text/plain', // 텍스트
        'application/msword', // Word
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // Word (새 형식)
        'application/vnd.ms-excel', // Excel
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' // Excel (새 형식)
      ];
    }
    
    // 기본적으로 모든 다른 경로는 거부
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}